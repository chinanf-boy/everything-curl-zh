
# 代理

网络上下文中的代理是一种中间人,是作为客户端和要通信的远程服务器之间的服务器.客户端与中间人联系,然后继续为您联系远程服务器.

公司和组织有时使用这种代理,在这种情况下,通常需要使用它们来达到目标服务器.

在与代理通信时,可以使用几种不同类型的代理以及不同的协议,libcurl支持一些最常见的代理协议.重要的是要认识到,代理所使用的协议不一定是与远程服务器相同的协议.

当用libcurl设置传输时,需要指出代理的服务器名称和端口号.您可能会发现,您喜欢的浏览器可以比libcurl稍微高级一点的方式完成这项工作,我们将在后面几节中详细讨论这些细节.

## 代理类型

libcurl支持两种主要代理类型:SOCKS和HTTP代理.更具体地说,它支持SOCKS4和SOCKS5以及本地代理的HTTP和HTTPS,它们都具有或不具有远程名称查找.

指定您正在谈论的代理的最简单方法是设置代理主机名字符串的方案部分(`CURLOPT_PROXY`匹配它:

```
socks4://proxy.example.com:12345/
socks4a://proxy.example.com:12345/
socks5://proxy.example.com:12345/
socks5h://proxy.example.com:12345/
http://proxy.example.com:12345/
https://proxy.example.com:12345/
```

`socks4`-具有本地名称解析的SOCKS4

`socks4a`-具有代理名称解析的SOCKS4

`socks5`-具有本地名称解析的SOCKS5

`socks5h`-意味着具有代理名称解析的SOCKS5

`http`-意味着HTTP,它总是允许代理解析名称.

`https`-意味着HTTPS**代理**它总是让代理解析名称(注意,最近在curl 7.52.0中添加了HTTPS代理支持,并且它仍然只对TLS库的一个子集起作用:OpenSSL、GnuTLS和NSS).

还可以选择使用单独的选项设置代理的类型,如果您只希望设置主机名,请使用`CURLOPT_PROXYTYPE`. 类似地,可以设置要使用的代理端口号.`CURLOPT_PROXYPORT`.

## 本地或代理名称查找

在上面的章节中,您可以看到,不同的代理设置允许名称解析由参与传输的不同各方完成.在某些情况下,您可以让客户端解析服务器主机名,并将IP地址传递给要连接的代理,这当然假设名称查找在客户端系统上正确工作,或者您可以将名称传递给代理,以便代理解析名称;将其还原为连接到的IP地址.

当您使用HTTP或HTTPS代理时,总是给代理的名称解析.

## 哪个代理?

如果网络连接需要使用代理才能到达目的地,则必须弄清楚这一点,并告诉libcurl使用正确的代理.在libcurl中没有支持它自动计算或检测代理.

当使用浏览器时,向代理提供PAC脚本或其他方法很流行,但是libcurl无法识别这些脚本.

### 代理环境变量

如果没有设置代理选项,libcurl将在执行其传输之前检查是否存在专门命名的环境变量,以查看是否请求使用代理.

可以通过设置变量名来指定代理`[scheme]_proxy`保存代理主机名(与您指定主机的方式相同)`-x`)因此,如果您想在访问HTTP服务器时告诉CURL使用代理,那么您就设置了"httpjyPosivServer"环境变量.这样地:

```
http_proxy=http://proxy.example.com:80
```

上面的代理示例是HTTP,但当然也可以设置.`ftp_proxy`,`https_proxy`对于要代理的特定协议,等等.除了HTTPJPro代理之外,所有这些代理环境变量名称也可以大写指定.`HTTPS_PROXY`.

设置控件的单个变量*全部的*协议,`ALL_PROXY`存在.如果一个特定的协议变量存在,这样的一个将优先.

当使用环境变量来设置代理时,您可能很容易陷入一种情况,即应该排除一个或多个主机名通过代理.这可以用`NO_PROXY`变量或对应的`CURLOPT_NOPROXY`libcurl选项.将其设置为逗号分隔的主机名列表,该列表在访问时不应使用代理.可以将NOIY代理设置为单个星号(’\*)匹配所有主机.

## HTTP代理

HTTP协议详细说明了如何使用HTTP代理.客户端(libcurl)不是将请求发送到实际的远程服务器,而是向代理请求特定的资源.与HTTP代理的连接是使用普通的未加密HTTP来实现的.

如果请求了HTTPS资源,则libcurl将发出`CONNECT`请求代理.这样的请求通过代理打开一个隧道,它基本上只是通过数据而不理解它.这样,即使存在HTTP代理,libcurl也可以建立安全的端到端TLS连接.

你*可以*通过HTTP代理的代理非HTTP协议,但由于这主要是通过CONNECT方法完成的,因此需要将代理配置为允许客户端连接到那些其他特定的远程端口号.许多HTTP代理被设置为禁止连接到其他端口号,而不是80和443.

## HTTPS代理

HTTPS代理与HTTP代理类似,但允许客户端使用安全的HTTPS连接连接到HTTPS代理.因为在这种情况下,代理连接与到远程站点的连接是分开的,因为到远程站点的HTTPS将通过到代理的HTTPS连接进行隧道传输,所以libcurl为代理连接提供了一组TLS选项,这些选项与连接到远程主机.

例如,`CURLOPT_PROXY_CAINFO`与HTTPS代理基本相同的功能`CURLOPT_CAINFO`是用于远程主机的.`CURLOPT_PROXY_SSL_VERIFYPEER`是代理版本`CURLOPT_SSL_VERIFYPEER`等等.

HTTPS代理在组织和公司中仍然是非常不寻常的.

## 代理认证

TBD

## 代理报头

TBD
