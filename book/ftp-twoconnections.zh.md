
## FTP使用两个连接

FTP使用两个TCP连接!第一连接是由客户端在连接到FTP服务器时建立的,称为*控制连接*. 作为初始连接,它处理身份验证并更改到远程服务器上的正确目录等.当客户端准备传输文件时,建立第二TCP连接,并通过该连接传输数据.

设置第二个连接会引起麻烦和头痛,原因有几个.

### 主动连接

客户端可以选择请求服务器连接到客户端来设置它,所谓的"活动"连接.这是用端口或EPRT命令完成的.允许远程主机在客户端打开的端口上连接到客户端,要求在这两者之间没有防火墙或其他网络设备,它们拒绝通过防火墙或其他网络设备,而且情况远非总是这样.您要求使用主动转账`curl -P [arg]`(也称为`--ftp-port`虽然该选项允许您精确地指定要使用哪个地址,但是设置与您来自的地址相同的地址几乎总是正确的选择,并且使用`-P -`像这样要求一个文件:

```
curl -P - ftp://example.com/foobar.txt
```

还可以显式地请求CURL不使用EPRT(这是比端口稍有更新的命令).`--no-eprt`命令行选项.

### 无源连接

Curl缺省设置为请求一个"被动"连接,这意味着它向服务器发送一个PASV或EPSV命令,然后服务器为第二个连接打开一个新端口,然后curl连接到该端口.对于终端用户和客户端来说,到新端口的传出连接通常更容易,限制也更少,但是它随后要求服务器端的网络允许.

默认情况下启用了被动连接,但如果您以前已打开了活动,则可以切换为被动连接.`--ftp-pasv`.

您还可以明确地请求CURL不使用EPSV(这是比PASV稍微稍微更新的命令).`--no-epsv`命令行选项.

有时服务器正在运行一个奇怪的设置,以便当curl发出PASV命令时,服务器用一个要连接到curl的IP地址进行响应,该地址是错误的,然后curl无法设置数据连接.对于这个(希望是罕见的)情况,您可以请求CURL忽略PASV响应中提到的IP地址(`--ftp-skip-pasv-ip`相反,甚至使用第二连接的控制连接的IP地址.

### 防火墙问题

使用主动或被动传输,网络路径中的任何现有防火墙都必须有状态地检查FTP流量,以找出新端口以打开该端口,并接受该端口用于第二连接.
